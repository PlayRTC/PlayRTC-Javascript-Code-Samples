/*! 
 * PLAYRTC. PLAYRTC is WebRTC SDK.
 * Copyright 2013, 2016 Heo Youngnam
 * 
 * project: PLAYRTC
 * version: 2.2.14
 * contact: cryingnavi@gmail.com
 * homepage: http://www.playrtc.com
 * Date: 2016-04-22 14:25 
 */
!function(a){var b=a();"object"==typeof module&&"object"==typeof module.exports?module.exports=b:window.PlayRTC=b}(function(){function a(a){p.trace("cdm",{klass:"Core",method:"request",message:"Called http request. options = "+JSON.stringify(a)});var b=new XMLHttpRequest;b.onreadystatechange=function(b){var c=b.target,d=c.responseText;if(4===c.readyState&&200===c.status&&d)try{p.trace("cdm",{klass:"Core",method:"request",message:"Received http request. res = "+d}),d=JSON.parse(d),d.error?a.error&&a.error(c,d):a.success&&a.success(d)}catch(b){p.error("cdm",{klass:"Core",method:"request",message:"Received http request. res = "+c.responseText}),a.error&&a.error(c,d)}else if(4===c.readyState&&200!==c.status)try{d=JSON.parse(d),a.error(c,d)}catch(b){p.error("cdm",{klass:"Core",method:"request",message:"Received http request. res = "+c.responseText}),a.error(c)}},b.open(a.method,a.url,!0),a.contentType?b.setRequestHeader("Content-Type",a.contentType):("firefox"===j.browser.name&&b.setRequestHeader("Accept","application/json"),b.setRequestHeader("Content-Type","application/json; charset=UTF-8")),a.projectKey&&b.setRequestHeader("TDCProjectKey",a.projectKey),a.body?b.send(JSON.stringify(a.body)):b.send()}function b(a,b,c){var d=null,e=null;switch(b){case"40102":case"40103":d="C4004",e=l.C4004;break;case"40104":d="C4005",e=l.C4005;break;default:d="C4006",e=l.C4006}this.fire("error",d,e,c)}function c(a,b){if(!g)return p.error("cdm",{method:"_call",message:"Your device is not supported media"}),this.error("M4001",l.M4001),!1;var c=this.userMedia;c.video||c.audio?this.getMedia()||g.call(navigator,c,j.bind(function(b){if(p.trace("cdm",{klass:"PlayRTC",method:"createUserMedia",message:"Got local stream. constraints = "+JSON.stringify(c)}),this.hasEvent("addLocalStream")){if(this.fire("addLocalStream",b)===!1&&this.config.localMediaTarget){var d=document.getElementById(this.config.localMediaTarget);d&&(d.hasAttribute("autoPlay")||d.setAttribute("autoPlay",!0),d.setAttribute("muted",!0),d.src=j.createObjectURL(b))}}else if(this.config.localMediaTarget){var d=document.getElementById(this.config.localMediaTarget);d&&(d.hasAttribute("autoPlay")||d.setAttribute("autoPlay",!0),d.setAttribute("muted",!0),d.src=j.createObjectURL(b))}this.createMedia(b),a.call(this),"function"==typeof j.mediaRecorderSupport&&j.mediaRecorderSupport(b)},this),j.bind(function(a){p.error("cdm",{klass:"PlayRTC",method:"createUserMedia",message:"Failed to get local stream. message = "+a.message}),this.destroy();var b=a.name.toUpperCase();"PERMISSIONDENIEDERROR"===b||"SECURITYERROR"===b?this.error("M4002",l.M4002,a):"DEVICESNOTFOUNDERROR"===b||"NOTFOUNDERROR"===b?this.error("M4003",l.M4003,a):this.error("M4004",l.M4004,a)},this)):this.dataChannelEnabled?a.call(this):b.call(this)}var d=function(){var a=window.PeerConnection||window.webkitPeerConnection00||window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.RTCPeerConnection;return a}(),e=function(){var a=window.mozRTCSessionDescription||window.RTCSessionDescription;return a}(),f=function(){var a=window.mozRTCIceCandidate||window.RTCIceCandidate;return a}(),g=function(){var a=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia;return a}(),h=function(){var a=window.URL||window.webkitURL||window.msURL||window.oURL;return a}(),j={};j.browser=function(){function a(a){var c=b.match(a);return c&&c.length>1&&c[1]||""}var b=navigator.userAgent,c=a(/version\/(\d+(\.\d+)?)/i),d=null;return/chrome|crios|crmo/i.test(b)?d={name:"chrome",version:a(/(?:chrome|crios|crmo)\/([\.1234567890]+)/i)}:/opera|opr/i.test(b)?d={name:"opera",version:c||a(/(?:opera|opr)[\s\/]([\.1234567890]+)/i)}:/msie|trident/i.test(b)?d={name:"ie",version:a(/(?:msie |rv:)(\d+(\.\d+)?)/i)}:/firefox|iceweasel/i.test(b)?d={name:"firefox",version:a(/(?:firefox|iceweasel)[ \/]([\.1234567890]+)/i)}:/safari/i.test(b)&&(d={name:"safari",version:c}),d}(),j.platform=function(){var a=navigator.userAgent.toLowerCase(),b=navigator.platform,c=/iPhone/i.test(b),d=/iPad/i.test(b),e=/iPod/i.test(b),f=/win/i.test(b),g=/mac/i.test(b),h=/linux/i.test(b),i=c||d||e,j=/android/i.test(a);return f?"windows":i?"ios":j?"android":g?"mac":h?"linux":void 0}(),j.language=function(){return navigator.languages?navigator.languages[0]:navigator.language||navigator.userLanguage}(),j.nation=function(){return j.language.split("-")[1]}(),j.Extend=function(a,b){var c=function(){var a=Array.prototype.slice.call(arguments);this.initialize.apply(this,a)},d=function(){},e=a.prototype;if(d.prototype=e,c.prototype=new d,c.prototype.constructor=c,c.base=e,b)for(var f in b)c.prototype[f]=b[f];return c.Extend=function(a){var b=this;return j.Extend(b,a)},c};var k=function(){};j.Event=j.Extend(k,{initialize:function(){this.listeners={}},on:function(a,b,c){this.listeners||(this.listeners={});var d=this.listeners[a]||(this.listeners[a]=[]);return d.push({callback:b,context:c}),this},off:function(a,b,c){var d,e,f,g,h;if(!a&&!b&&!c)return this.listeners=void 0,this;if(f=this.listeners[a]){if(this.listeners[a]=d=[],b||c)for(g=0,h=f.length;h>g;g++)e=f[g],(b&&b!==e.callback||c&&c!==e.context)&&d.push(e);d.length||delete this.listeners[a]}return this},fire:function(a){if(!this.listeners)return this;var b=Array.prototype.slice.call(arguments,1),c=this.listeners[a],d=-1;if(c){var e=c.length;switch(b.length){case 0:if(1===e)return(ev=c[0]).callback.call(ev.context);for(;++d<e;)(ev=c[d]).callback.call(ev.context);return this;default:if(1===e)return(ev=c[0]).callback.apply(ev.context,b);for(;++d<e;)(ev=c[d]).callback.apply(ev.context,b);return this}}return this},clear:function(){this.listeners={}},hasEvent:function(a){return this.listeners[a]?!0:!1}}),j.apply=function(a,b){if(!a||!b)throw new Error("Failed to execute 'apply' on 'utils': 2 arguments required, but only "+arguments.length+" present.");if("object"==typeof b&&("number"==typeof a||"boolean"==typeof a||"string"==typeof a))return a=b;var c=null;for(c in b)"object"==typeof b[c]&&b[c]&&!b[c].hasOwnProperty("length")?a[c]=j.apply(a[c]||{},b[c]):a[c]=b[c];return a},j.bind=function(a,b){if(!a||!b)throw new Error("Failed to execute 'bind' on 'utils': 2 arguments required, but only "+arguments.length+" present.");return function(){a.apply(b,Array.prototype.slice.call(arguments))}},j.fileDownload=function(a,b){var c=document,d=c.createElementNS("http://www.w3.org/1999/xhtml","a"),e=c.createEvent("MouseEvents");d.href=h.createObjectURL(a),d.download=b,e.initEvent("click",!0,!1),d.dispatchEvent(e)},j.createVideo=function(a,b){var c={autoPlay:!0,controls:!0,width:"100%",height:"100%"},d=document.createElement("video");return b=b||{},c=j.apply(c,b),c.controls&&d.setAttribute("controls",!0),c.autoPlay&&d.setAttribute("autoPlay",!0),d.setAttribute("width",c.width),d.setAttribute("height",c.height),d.src=j.createObjectURL(a),d},j.createAudio=function(a,b){var c={autoPlay:!0,controls:!0},d=document.createElement("audio");return b=b||{},c=j.apply(c,b),c.controls&&d.setAttribute("controls",!0),c.autoPlay&&d.setAttribute("autoPlay",!0),d.src=j.createObjectURL(a),d},j.createObjectURL=function(a){return h.createObjectURL(a)},j.blobWorkerSupport=function(){try{var a=function(a){}.toString(),b=new Blob(["this.onmessage = "+a],{type:"application/javascript"});b=h.createObjectURL(b);new Worker(b);return h.revokeObjectURL(b),!0}catch(c){return!1}}(),j.mediaRecorderSupport=function(a){try{new MediaRecorder(a),j.mediaRecorderSupport=!0}catch(b){j.mediaRecorderSupport=!1}},j.userMediaSupport=!!g||!1,j.exportLog=function(){p.db.exportLog()},j.debugViewShow=function(){p.monitor.show()},j.debugViewHide=function(){p.monitor.hide()},j.strFormat=function(a){for(var b=arguments,c=b.length,d=null,e=0;c>e;e++)d=new RegExp("\\{"+e+"\\}","g"),a=a.replace(d,b[e+1]);return a};var l={M4001:"Unsupported media",M4002:"Permission denied",M4003:"Devices not found",M4004:"Unknown media error",C4001:"Failed allocate channel",C4002:"Failed to connect channel's server",C4003:"Already disconnected channel's server",C4004:"Invalid authentication of channel",C4005:"Invalid channel id",C4006:"Channel error",C4007:"Channel's socket error",C4008:"Failed to create sdp",C4009:"Failed to register sdp",C4010:"Failed to register candidate",C4011:"Failed to request nag's ice servers",P4001:"Failed P2P",A4001:"Failed to create ActiveX"},m={20001:"SUCCESS",40001:"MESSAGE_SYNTAX_ERROR",40101:"PROJECTID_INVALID",40102:"TOKEN_INVALID",40103:"TOKEN_EXPIRED",40104:"CHANNELID_INVALID",40105:"PEERID_INVALID",40106:"UNKNOWN_CONNECTION",40107:"UNKNOWN_COMMAND"},n=j.Extend(j.Event,{initialize:function(a){n.base.initialize.call(this),this.socket=new WebSocket(a),this.setEvent()},setEvent:function(){this.socket.onopen=j.bind(function(a){this.fire("open",a)},this),this.socket.onclose=j.bind(function(a){this.fire("close",a)},this),this.socket.onerror=j.bind(function(a){this.fire("error",a)},this),this.socket.onmessage=j.bind(function(a){this.fire("message",a)},this)},send:function(a){try{this.socket.send(a)}catch(b){}},getReadyState:function(){return this.socket.readyState},close:function(){this.socket&&this.socket.close()}}),o=j.Extend(j.Event,{initialize:function(a){if(!a.projectKey)return void p.error("cdm",{klass:"PlayRTC",method:"initialize",message:"Failed to execute 'initialize' on 'PlayRTC': projectKey required, not present"});if(p.trace("cdm",{klass:"PlayRTC",method:"initialize",message:"Created instance of 'PlayRTC'"}),this.config={projectKey:null,ring:!1,iceServers:null,localVideoTarget:null,remoteVideoTarget:null,localMediaTarget:null,remoteMediaTarget:null,dataChannelEnabled:!0,logLevel:"TRACE",userMedia:{audio:!0,video:!0},video:!0,audio:!0,data:!0,bandwidth:{video:1500,data:1638400}},this.iceServers=[],this.media=null,this.userMedia={audio:this.config.userMedia.audio,video:this.config.userMedia.video},this.dataChannelEnabled=this.config.dataChannelEnabled,o.base.initialize.call(this),j.apply(this.config,a),a.hasOwnProperty("video")&&(this.userMedia.video=a.video),a.hasOwnProperty("audio")&&(this.userMedia.audio=a.audio),a.hasOwnProperty("data")&&(this.dataChannelEnabled=a.data),"firefox"===o.utils.browser.name)"boolean"!=typeof this.userMedia.audio&&(this.userMedia.audio=!0);else if(this.userMedia.audio===!0)this.userMedia.audio={optional:[{googEchoCancellation:!0},{googAutoGainControl:!0},{googNoiseReduction:!0},{googNoiseSuppression:!0},{googHighpassFilter:!0}],mandatory:{}};else if("boolean"!=typeof this.userMedia.audio){var b={optional:[{googEchoCancellation:!0},{googAutoGainControl:!0},{googNoiseReduction:!0},{googNoiseSuppression:!0},{googHighpassFilter:!0}],mandatory:{}};this.userMedia.audio.hasOwnProperty("echoCancellation")&&(b.optional[0].googEchoCancellation=this.userMedia.audio.echoCancellation),this.userMedia.audio.hasOwnProperty("autoGainControl")&&(b.optional[1].googAutoGainControl=this.userMedia.audio.autoGainControl),this.userMedia.audio.hasOwnProperty("noiseReduction")&&(b.optional[2].googNoiseReduction=this.userMedia.audio.noiseReduction),this.userMedia.audio.hasOwnProperty("noiseSuppression")&&(b.optional[3].googNoiseSuppression=this.userMedia.audio.noiseSuppression),this.userMedia.audio.hasOwnProperty("highpassFilter")&&(b.optional[4].googHighpassFilter=this.userMedia.audio.highpassFilter),this.userMedia.audio=b}if("firefox"===o.utils.browser.name){if("boolean"!=typeof this.userMedia.video){var c={};this.userMedia.video.hasOwnProperty("minWidth")&&(c.width?c.width.min=this.userMedia.video.minWidth:c.width={min:this.userMedia.video.minWidth}),this.userMedia.video.hasOwnProperty("minHeight")&&(c.height?c.height.min=this.userMedia.video.minHeight:c.height={min:this.userMedia.video.minHeight}),this.userMedia.video.hasOwnProperty("maxWidth")&&(c.width?c.width.max=this.userMedia.video.maxWidth:c.width={max:this.userMedia.video.maxWidth}),this.userMedia.video.hasOwnProperty("maxHeight")&&(c.height?c.height.max=this.userMedia.video.maxHeight:c.height={max:this.userMedia.video.maxHeight}),this.userMedia.video.hasOwnProperty("minFrameRate")&&(c.frameRate?c.frameRate.min=this.userMedia.video.minFrameRate:c.frameRate={min:this.userMedia.video.minFrameRate}),this.userMedia.video.hasOwnProperty("maxFrameRate")&&(c.frameRate?c.frameRate.max=this.userMedia.video.maxFrameRate:c.frameRate={max:this.userMedia.video.maxFrameRate}),this.userMedia.video=c}}else if("boolean"!=typeof this.userMedia.video){var c={optional:[],mandatory:{}};this.userMedia.video.hasOwnProperty("minWidth")&&(c.mandatory.minWidth=this.userMedia.video.minWidth),this.userMedia.video.hasOwnProperty("minHeight")&&(c.mandatory.minHeight=this.userMedia.video.minHeight),this.userMedia.video.hasOwnProperty("maxWidth")&&(c.mandatory.maxWidth=this.userMedia.video.maxWidth),this.userMedia.video.hasOwnProperty("maxHeight")&&(c.mandatory.maxHeight=this.userMedia.video.maxHeight),this.userMedia.video.hasOwnProperty("minFrameRate")&&(c.mandatory.minFrameRate=this.userMedia.video.minFrameRate),this.userMedia.video.hasOwnProperty("maxFrameRate")&&(c.mandatory.maxFrameRate=this.userMedia.video.maxFrameRate),this.userMedia.video=c}return u.setProjectKey(this.config.projectKey),this.config.logLevel=this.config.logLevel.toUpperCase(),p.setLogLevel(this.config.logLevel),this.config.localVideoTarget&&(this.config.localMediaTarget=this.config.localVideoTarget),this.config.remoteVideoTarget&&(this.config.remoteMediaTarget=this.config.remoteVideoTarget),this.userMedia.audio||this.userMedia.video||this.dataChannelEnabled?void 0:void p.error("cdm",{klass:"PlayRTC",method:"initialize",message:"Might be true one of video or audio or dataChannel"})},_setServers:function(a,b,c){var d=null;d=this.config.iceServers?this.config.iceServers:[{url:"turn:"+c.turnserver.turnIp+":"+c.turnserver.turnPort,credential:c.turnserver.turnPw,username:c.turnserver.turnId}],this.nagToken=b,this.iceServers=d,this.channelServer=a.channelUrl,this.nagServer=a.nagRestUrl,this.fractionLost=a.fractionLost,p.trace("cdm",{klass:"PlayRTC",method:"_setServers",message:"Set servers channelServer["+this.channelServer+"] nagServer["+this.nagServer+"] iceServers["+JSON.stringify(this.iceServers)+"]"})},_createCall:function(a,b,c){this.calling=new q(this,{nagToken:this.nagToken,token:a,channelId:b,uid:c}),this.calling.on("addRemoteStream",this.addRemoteStream,this).on("_disconnectChannel",this._disconnectChannel,this).on("_otherDisconnectChannel",this._otherDisconnectChannel,this).on("stateChange",this._stateChange,this).on("error",this.error,this).on("userCommand",this.onUserCommand,this)},createChannel:function(a){return this.calling?void p.error("cdm",{klass:"PlayRTC",method:"createChannel",message:"Already connected channel"}):(a=a||{},a.env={os:j.platform,device:j.browser.name,version:"",carrier:"",country:j.nation,networkType:"wired"},p.trace("cdm",{klass:"PlayRTC",method:"createChannel",message:"Called createChannel. data = "+JSON.stringify(a)}),void c.call(this,function(){u.createChannel(a,j.bind(function(b){var c=b.channelId,d=b.token.tokenId,e=b.configuration,f=a.peer?a.peer.uid||"":"";this._setServers(e,b.nag.data.authToken,b.turn),this._createCall(d,c,f),this.fire("connectChannel",c,"create")},this),j.bind(function(a,b){this.destroy(),p.trace("cdmn",{klass:"PlayRTC",method:"createChannel",type:"p2p",callType:"caller",resultCode:"300",connectTime:(new Date).getTime(),networkType:"wired",candidate:"",audioYn:this.userMedia.audio?"Y":"N",videoYn:this.userMedia.video?"Y":"N",message:"Status["+a.status+"] Failed createChannel. data = "+JSON.stringify(b)}),this.error("C4001",l.C4001,b)},this))},function(){p.error("cdm",{klass:"PlayRTC",method:"createChannel",message:"Must set 'true' video or audio or data"})}))},connectChannel:function(a,b){return this.calling?void p.error("cdm",{klass:"PlayRTC",method:"connectChannel",message:"Already connected channel"}):a?(b=b||{},b.env={os:j.platform,device:j.browser.name,version:"",carrier:"",country:j.nation,networkType:"wired"},p.trace("cdm",{klass:"PlayRTC",method:"connectChannel",channelId:a,message:"Called connectChannel. data = "+JSON.stringify(b)}),void c.call(this,function(){u.connectChannel(a,b,j.bind(function(a){var c=a.channelId,d=a.token.tokenId,e=a.configuration,f=b.peer?b.peer.uid||"":"";this._setServers(e,a.nag.data.authToken,a.turn),this._createCall(d,c,f),this.fire("connectChannel",c,"connect")},this),j.bind(function(a,b){this.destroy(),p.trace("cdmn",{klass:"PlayRTC",method:"connectChannel",type:"p2p",callType:"callee",resultCode:"300",connectTime:(new Date).getTime(),networkType:"wired",candidate:"",audioYn:this.userMedia.audio?"Y":"N",videoYn:this.userMedia.video?"Y":"N",message:"Status["+a.status+"] Failed connectChannel. data = "+JSON.stringify(b)}),this.error("C4001",l.C4001,b)},this))},function(){p.error("cdm",{klass:"PlayRTC",method:"connectChannel",message:"Must set 'true' video or audio or data"})})):void p.error("cdm",{klass:"PlayRTC",method:"connectChannel",message:"Failed to execute 'connectChannel' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},disconnectChannel:function(a){this.calling&&(p.trace("cdm",{klass:"PlayRTC",method:"disconnectChannel",channelId:this.getChannelId(),message:"Called disconnectChannel"}),a=a||this.getPeerId(),this.calling.channeling.disconnectChannel(a),window.setTimeout(j.bind(function(){if(a===this.getPeerId()&&this.calling){p.trace("cdm",{klass:"PlayRTC",method:"deleteChannel",channelId:this.getChannelId(),message:"Force disconnectChannel"});var b=this.getChannelId();this.destroy(),this.fire("disconnectChannel",b,a)}},this),2e3))},deleteChannel:function(){this.calling&&(p.trace("cdm",{klass:"PlayRTC",method:"deleteChannel",channelId:this.getChannelId(),message:"Called deleteChannel"}),this.calling.channeling.deleteChannel(),window.setTimeout(j.bind(function(){if(this.calling){p.trace("cdm",{klass:"PlayRTC",method:"deleteChannel",channelId:this.getChannelId(),message:"Force deleteChannel"});var a=this.getChannelId(),b=this.getPeerId();this.destroy(),this.fire("disconnectChannel",a,b)}},this),2e3))},getChannelList:function(a,b){p.trace("cdm",{klass:"PlayRTC",method:"getChannelList",message:"Called getChannelList"}),u.getChannelList(j.bind(function(b){a&&a(b)},this),j.bind(function(a,c){p.error("cdm",{klass:"PlayRTC",method:"getChannelList",message:"Status["+a.status+"] Failed getChannelList. data = "+JSON.stringify(c)}),b&&b(a,c)},this))},getChannel:function(a,b,c){return a?(p.trace("cdm",{klass:"PlayRTC",method:"getChannel",message:"Called getChannel"}),void u.getChannel(a,j.bind(function(a){b&&b(a)},this),j.bind(function(a,b){p.error("cdm",{klass:"PlayRTC",method:"getChannel",message:"Status["+a.status+"] Failed getChannel. data = "+JSON.stringify(b)}),c&&c(a,b)},this))):void p.error("cdm",{klass:"PlayRTC",method:"getChannel",message:"Failed to execute 'getChannel' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},getPeerList:function(a,b,c){return a?(p.trace("cdm",{klass:"PlayRTC",method:"getPeerList",message:"Called getPeerList"}),void u.getPeerList(a,j.bind(function(a){b&&b(a)},this),j.bind(function(a,b){p.error("cdm",{klass:"PlayRTC",method:"getPeerList",message:"Status["+a.status+"] Failed getPeerList. data = "+JSON.stringify(b)}),c&&c(a,b)},this))):void p.error("cdm",{klass:"PlayRTC",method:"getPeerList",message:"Failed to execute 'getPeerList' on 'PlayRTC': 1 arguments required, but only "+arguments.length+" present"})},getPeer:function(a,b,c,d){return a&&b?(p.trace("cdm",{klass:"PlayRTC",method:"getPeer",message:"Called getPeer"}),void u.getPeer(a,b,j.bind(function(a){c&&c(a)},this),j.bind(function(a,b){p.error("cdm",{klass:"PlayRTC",method:"getPeer",message:"Status["+a.status+"] Failed getPeer. data = "+JSON.stringify(b)}),d&&d(a,b)},this))):void p.error("cdm",{klass:"PlayRTC",method:"getPeer",message:"Failed to execute 'getPeer' on 'PlayRTC': 2 arguments required, but only "+arguments.length+" present"})},searchChannel:function(a,b,c,d){return a&&b?(p.trace("cdm",{klass:"PlayRTC",method:"searchChannel",message:"Called searchChannel"}),void u.searchChannel(a,b,j.bind(function(a){c&&c(a)},this),j.bind(function(a,b){p.error("cdm",{klass:"PlayRTC",method:"searchChannel",message:"Status["+a.status+"] Failed searchChannel. data = "+JSON.stringify(b)}),d&&d(a,b)},this))):void p.error("cdm",{klass:"PlayRTC",method:"searchChannel",message:"Failed to execute 'searchChannel' on 'PlayRTC': 2 arguments required, but only "+arguments.length+" present"})},getPeerByPeerId:function(a){if(!this.calling)return null;var b=this.calling.peers[a];return b?b.peer:null},getPeerByUserId:function(a){if(!this.calling)return null;var b=null,c=this.calling.peers;for(b in c)if(c[b].uid===a)return c[b].peer;return null},getAllPeer:function(){if(!this.calling)return null;var a=this.calling.peers,b=[],c=null;for(c in a)b.push(a[c].peer);return b},getPeerId:function(){return this.calling?this.calling.getPid():null},getChannelId:function(){return this.calling?this.calling.getChannelId():null},addRemoteStream:function(a,b,c){if(this.hasEvent("addRemoteStream")){if(this.fire("addRemoteStream",a,b,c)===!1&&this.config.remoteMediaTarget){var d=document.getElementById(this.config.remoteMediaTarget);d&&(d.hasAttribute("autoPlay")||d.setAttribute("autoPlay",!0),d.src=j.createObjectURL(c))}}else if(this.config.remoteMediaTarget){var d=document.getElementById(this.config.remoteMediaTarget);d&&(d.hasAttribute("autoPlay")||d.setAttribute("autoPlay",!0),d.src=j.createObjectURL(c))}},createMedia:function(a){return this.media=new s(a),this.media},getMedia:function(){return this.media},getConfig:function(){return this.config},dataSend:function(){if(p.warn("cdm",{klass:"PlayRTC",method:"dataSend",message:"dataSend is deprecated. please use get sendText of sendFile"}),!this.calling)return!1;if(arguments.length<1)return!1;var a=null,b=null,c=0,d=0,e=null,f=arguments,g=f[0],h=null,i=null,j=null;if(p.trace("cdm",{klass:"PlayRTC",method:"dataSend",channelId:this.getChannelId(),message:"Sent data. data = "+g}),"string"==typeof f[1]?(h=f[1],3===f.length?i=f[2]:4===f.length&&(i=f[2],j=f[3])):"function"==typeof f[1]&&(i=f[1],3===f.length&&(j=f[2])),h){if(a=this.getPeerByPeerId(h)||this.getPeerByUserId(h))return e=a.getDataChannel(),void(e&&e.send(g,i,j))}else for(b=this.getAllPeer(),d=b.length;d>c;c++)e=b[c].getDataChannel(),e&&e.send(g,i,j)},_dataSend:function(){if(!this.calling)return!1;if(arguments.length<1)return!1;var a=null,b=null,c=0,d=0,e=null,f=arguments,g=f[0],h=null,i=null,j=null;if(p.trace("cdm",{klass:"PlayRTC",method:"dataSend",channelId:this.getChannelId(),message:"Sent data. data = "+g}),"string"==typeof f[1]?(h=f[1],3===f.length?i=f[2]:4===f.length&&(i=f[2],j=f[3])):"function"==typeof f[1]&&(i=f[1],3===f.length&&(j=f[2])),h){if(a=this.getPeerByPeerId(h)||this.getPeerByUserId(h))return e=a.getDataChannel(),void(e&&e.send(g,i,j))}else for(b=this.getAllPeer(),d=b.length;d>c;c++)e=b[c].getDataChannel(),e&&e.send(g,i,j)},sendText:function(){return this.calling?arguments.length<1?!1:(p.trace("cdm",{klass:"PlayRTC",method:"sendText",channelId:this.getChannelId(),message:"Sent data. data = "+arguments[0]}),void this._dataSend.apply(this,Array.prototype.slice.call(arguments))):!1},sendFile:function(){return this.calling?arguments.length<1?!1:(p.trace("cdm",{klass:"PlayRTC",method:"sendFile",channelId:this.getChannelId(),message:"Sent data. data = "+arguments[0]}),void this._dataSend.apply(this,Array.prototype.slice.call(arguments))):!1},userCommand:function(a,b){if(!this.calling)return!1;p.trace("cdm",{klass:"PlayRTC",method:"userCommand",channelId:this.getChannelId(),message:"Sent data. data = "+a});var c=null;b?(c=this.getPeerByPeerId(b)||this.getPeerByUserId(b),c&&this.calling.channeling.userCommand(a,[{id:c.id}])):this.calling.channeling.userCommand(a,[])},onUserCommand:function(a,b){var c=this.getPeerByPeerId(a);c&&this.fire("userCommand",a,c.uid,b)},_disconnectChannel:function(a,b){this.destroy(),this.fire("disconnectChannel",a,b)},_otherDisconnectChannel:function(a,b){var c=document.getElementById(this.config.remoteMediaTarget);c&&(c.src=""),this.fire("otherDisconnectChannel",a,b)},error:function(a,b,c){this.fire("error",a,b,c)},_stateChange:function(a,b,c){this.fire("stateChange",a,b,c)},destroy:function(){if(this.calling){p.trace("cdm",{klass:"PlayRTC",method:"destroy",message:"Destroyed instance of 'PlayRTC'"}),this.calling.destroy(),this.calling=null;var a=document.getElementById(this.config.remoteMediaTarget);a&&(a.src="");var b=document.getElementById(this.config.localMediaTarget);b&&(b.src="")}this.media&&(this.media.stop(),this.media=null)},close:function(){this.destroy()},accept:function(a){this.calling&&this.calling.accept(a)},reject:function(a){this.calling&&this.calling.reject(a)},startStatsReport:function(a,b,c){var d=this.getPeerByPeerId(a);return d?(d.startStatsReport(b,c),!0):!1},stopStatsReport:function(a){var b=this.getPeerByPeerId(a);return b?(b.stopStatsReport(),!0):!1}}),p=function(){var a=j.Extend(k,{initialize:function(){},trace:function(){},warn:function(){},error:function(){},dateFormat:function(a){var b=a.getFullYear().toString(),c=(a.getMonth()+1).toString(),d=a.getDate().toString(),e=a.getHours().toString(),f=a.getMinutes().toString(),g=a.getSeconds().toString(),h=a.getMilliseconds();return j.strFormat("{0}/{1}/{2} {3}:{4}:{5}.{6}",b,function(){return c[1]?c:"0"+c[0]},function(){return d[1]?d:"0"+d[0]},function(){return e[1]?e:"0"+e[0]},function(){return f[1]?f:"0"+f[0]},function(){return g[1]?g:"0"+g[0]},function(){return 10>h?h="00"+h:100>h&&(h="0"+h),h})}}),b=function(b,c){var d,e=null;return o.loggers[b]?e=o.loggers[b]:(d=j.Extend(a,c),e=o.loggers[b]=new d),e};return o.loggers={},{level:0,LOGLEVEL:{TRACE:0,WARN:1,ERROR:2,NONE:3},typeEach:function(a,b){for(var c=null,d=a.length,e=null;d--;){switch(c=a[d].toUpperCase()){case"C":e=p.console;break;case"N":e=p.network;break;case"D":e=p.db;break;case"M":e=p.monitor}e&&b.call(e),e=null}},trace:function(a,b){this.LOGLEVEL.TRACE<this.level||(b.logType="TRACE",this.typeEach(a,function(){this.trace(b)}))},warn:function(a,b){this.LOGLEVEL.WARN<this.level||(b.logType="WARN",this.typeEach(a,function(){this.warn(b)}))},error:function(a,b){this.LOGLEVEL.ERROR<this.level||(b.logType="ERROR",this.typeEach(a,function(){this.error(b)}))},setLogLevel:function(a){this.level=this.LOGLEVEL[a],this.level||(this.level=0)},console:b("console",{initialize:function(){this.console=window.console,this.debugFn=this.console.debug?"debug":"log"},trace:function(a){this.console[this.debugFn](this.format(a))},warn:function(a){this.console.warn(this.format(a))},error:function(a){this.console.error(this.format(a))},format:function(a){var b=this.dateFormat(new Date),c="["+a.logType+"]",d=a.channelId?"["+a.channelId+"]":"",e=a.klass?"["+a.klass+"]":"",f=a.method?"["+a.method+"]":"",g=a.message||"";return j.strFormat("{0} {1} {2} {3} {4} {5}",b,c,d,e,f,g).replace(/(?:\s\s)+/g," ")}}),monitor:b("monitor",{initialize:function(){function a(){}this.view={setLog:a,show:a,hide:a,exportLog:a,trace:a,error:a,warn:a}},show:function(){this.view.show()},hide:function(){this.view.hide()},trace:function(a){this.view.trace(this.format(a))},warn:function(a){this.view.warn(this.format(a))},error:function(a){this.view.error(this.format(a))},format:function(a){var b=this.dateFormat(new Date),c="["+a.logType+"]",d=a.channelId?"["+a.channelId+"]":"",e=a.klass?"["+a.klass+"]":"",f=a.method?"["+a.method+"]":"",g=a.message||"";return j.strFormat("{0} {1} {2} {3} {4} {5}",b,c,d,e,f,g).replace(/(?:\s\s)+/g," ")}}),db:b("db",{initialize:function(){this.db=null,this.logsData=[];try{window.openDatabase&&(this.db=openDatabase("PlayRTC","1.0","PlayRTC Log Database",20910080),this.db.transaction(function(a){a.executeSql("select * from logs",[],function(){var b="delete from logs where logdate < datetime('now', '-10 day')";a.executeSql(b)},function(a,b){var c="create table if not exists logs (id integer primary key autoincrement,logdate datetime default current_time, log text)";a.executeSql(c)})}))}catch(a){}},trace:function(a){this.save(this.format(a))},warn:function(a){this.save(this.format(a))},error:function(a){this.save(this.format(a))},save:function(a){try{this.db.transaction(function(b){var c="insert into logs(log) values (?)";b.executeSql(c,[a])})}catch(b){}},exportLog:function(){try{this.db.transaction(j.bind(function(a){var b="select * from logs;";a.executeSql(b,[],j.bind(function(a,b){for(var c=null,d=0;d<b.rows.length;d++)c=b.rows.item(d),this.logsData.push(c.log+"\r\n");b.rows.length&&this.processEnd()},this))},this))}catch(a){}},processEnd:function(){var a=new Blob(this.logsData,{type:"text/plain"});this.logsData=[],j.fileDownload(a,this.dateFormat(new Date)+"_log.txt")},format:function(a){var b=this.dateFormat(new Date),c="["+a.logType+"]",d=a.channelId?"["+a.channelId+"]":"",e=a.klass?"["+a.klass+"]":"",f=a.method?"["+a.method+"]":"",g=a.message||"";return j.strFormat("{0} {1} {2} {3} {4} {5}",b,c,d,e,f,g)}}),network:b("network",{initialize:function(){this.config={projectKey:null,interval:6e4},this.storage=window.localStorage,this.q=[]},trace:function(a){u.log(this.format(a),function(){})},warn:function(a){u.log(this.format(a),function(){})},error:function(a){u.log(this.format(a),function(){})},format:function(a){var b=j.apply({},a);return delete b.klass,delete b.method,delete b.message,delete b.logType,b}})}}(),q=j.Extend(j.Event,{initialize:function(a,b){q.base.initialize.call(this),this.pid=null,this.token=b.token,this.nagToken=b.nagToken,this.uid=b.uid,this.channelId=b.channelId,this.channelServer=a.channelServer,this.turnInterval=null,this.healthInterval=null,this.peers={},this.playRtc=a,p.trace("cdm",{klass:"Call",method:"initialize",channelId:this.channelId,message:"Created instance of 'Call'"}),this.channeling=new o.Channeling(this,this.channelServer),this.channeling.on("onOpen",this.connect,this).on("onConnect",this.onConnect,this).on("onOtherConnect",this.onOtherConnect,this).on("onRing",this.onRing,this).on("onAccept",this.onAccept,this).on("onReject",this.onReject,this).on("onClose",this.onClose,this).on("onOtherClose",this.onOtherClose,this).on("error",this.error,this).on("userCommand",this.onUserCommand,this).on("receiveOfferSdp",this.receiveOfferSdp,this).on("receiveAnwserSdp",this.receiveAnwserSdp,this).on("receiveCandidate",this.receiveCandidate,this)},getChannelId:function(a){return this.channelId},getToken:function(){return this.token},getNagToken:function(){return this.nagToken},setPid:function(a){p.trace("cdm",{klass:"Call",method:"setPid",channelId:this.getChannelId(),message:"PID["+a+"] Set self pid"}),this.pid=a},getPid:function(a){return this.pid},getUid:function(a){return this.uid},requestTurn:function(b,c){p.trace("cdm",{klass:"Call",method:"requestTurn",channelId:this.getChannelId(),message:"Called requestTurn"});var d=this.playRtc.nagServer+"/webrtcsignaling/v1/"+this.getToken()+"/turnserver?authToken="+this.getNagToken();a({method:"get",url:d,contentType:"application/x-www-form-urlencoded",success:b,error:c})},connect:function(){var a=this.getChannelId();p.trace("cdm",{klass:"Call",method:"connect",channelId:a,message:"Token["+this.getToken()+"] UID["+this.getUid()+"] Connected of channel"}),this.channeling.connect(a)},accept:function(a){if(!a)return p.error("cdm",{klass:"Call",method:"accept",channelId:this.getChannelId(),message:"Failed to execute 'accept' on 'Call': 1 arguments required, but only "+arguments.length+" present"}),!1;p.trace("cdm",{klass:"Call",method:"accept",channelId:this.getChannelId(),message:"OtherPID["+a+"] Accepted other peer"}),this.channeling.accept(a);for(attr in this.peers)this.peers[attr].type="answer"},reject:function(a){return a?(p.trace("cdm",{klass:"Call",method:"reject",channelId:this.getChannelId(),message:"OtherPID["+a+"] Rejected other peer"}),delete this.peers[a],void this.channeling.reject(a)):(p.error("cdm",{klass:"Call",method:"reject",channelId:this.getChannelId(),message:"Failed to execute 'reject' on 'Call': 1 arguments required, but only "+arguments.length+" present"
}),!1)},ring:function(a){p.trace("cdm",{klass:"Call",method:"ring",channelId:this.getChannelId(),message:"OtherPID["+a+"] Sent to ring to other peer"}),this.channeling.ring(a)},createPeer:function(a,b){var c=this.playRtc,d=this.playRtc.getMedia(),e=d?d.getStream():null,f=null;return this.peers[a]||(this.peers[a]={}),this.peers[a].peer?void 0:(this.peers[a].uid||(this.peers[a].uid=b||""),f={iceServers:c.iceServers,dataChannelEnabled:c.dataChannelEnabled,bandwidth:c.getConfig().bandwidth},this.peers[a].peer=new r(this,a,this.peers[a].uid,e,f),this.peers[a].peer.on("sendOfferSdp",this.sendOfferSdp,this).on("sendAnswerSdp",this.sendAnswerSdp,this).on("sendCandidate",this.sendCandidate,this).on("addRemoteStream",this.addRemoteStream,this).on("signalEnd",this.signalEnd,this).on("error",function(a,b,c){this.fire("error",a,b,c)},this).on("stateChange",this._stateChange,this),this.peers[a])},onConnect:function(a,b){var c=null;this.setPid(a),p.trace("cdm",{klass:"Call",method:"onConnect",channelId:this.getChannelId(),message:"Channel connecting is success"});var d=0,e=b.length;if(e>0)if(this.playRtc.config.ring)for(;e>d;d++)this.ring(b[d].id);else for(;e>d;d++)c=this.createPeer(b[d].id,b[d].uid),c.type="offer",c.peer.createOffer();else this._startTurnInterval();this.channeling.health(),this.healthInterval=window.setInterval(j.bind(function(){this.channeling.health()},this),3e4)},_startTurnInterval:function(){this.playRtc.config.iceServers||(this.turnInterval=window.setInterval(j.bind(function(){this.requestTurn(j.bind(function(a){p.trace("cdm",{klass:"Call",method:"onConnect",channelId:this.getChannelId(),message:"Received nag turn server. iceServer = "+JSON.stringify(a)});var b=[{url:"turn:"+a.data.turnserver.turnIp+":"+a.data.turnserver.turnPort,credential:a.data.turnserver.turnPw,username:a.data.turnserver.turnId}];this.playRtc.iceServers=b},this),j.bind(function(){window.clearInterval(this.turnInterval),this.error("C4011",l.C4011)},this))},this),4e4))},onOtherConnect:function(a,b){this.turnInterval&&(window.clearInterval(this.turnInterval),this.turnInterval=null);this.playRtc.config.ring||this.peers[a]||(this.peers[a]={},this.peers[a].type="answer",this.peers[a].uid=b)},onRing:function(a,b){return p.trace("cdm",{klass:"Call",method:"onRing",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+b+"] Received to ring from other peer"}),this.peers[a]={uid:b},this.playRtc.hasEvent("ring")?void this.playRtc.fire("ring",a,b):(alert("You must create ring event."),!1)},onAccept:function(a,b){p.trace("cdm",{klass:"Call",method:"onAccept",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+b+"] Received to accept from other peer"});var c=this.createPeer(a,b);c.type="offer",c.peer.createOffer(),this.playRtc.fire("accept",a,b)},onReject:function(a,b){p.trace("cdm",{klass:"Call",method:"onReject",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+b+"] Received to reject from other peer"}),this.playRtc.fire("reject",a,b)},sendOfferSdp:function(a,b){this.channeling.sendOfferSdp(a,b)},sendAnswerSdp:function(a,b){this.channeling.sendAnswerSdp(a,b)},sendCandidate:function(a,b){this.channeling.sendCandidate(a,b)},receiveOfferSdp:function(a,b,c){var d=this.peers[a],e=null;e=d&&d.peer?d.peer:this.createPeer(a).peer,p.trace("cdm",{klass:"Call",method:"receiveOfferSdp",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer offer sdp"}),e.createAnswer(b)},receiveAnwserSdp:function(a,b){p.trace("cdm",{klass:"Call",method:"receiveAnwserSdp",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer anwser sdp"});var c=this.peers[a].peer;c.receiveAnwserSdp(b)},receiveCandidate:function(a,b,c){var d=this.peers[a],e=null;e=d&&d.peer?d.peer:this.createPeer(a).peer,p.trace("cdm",{klass:"Call",method:"receiveCandidate",channelId:this.getChannelId(),message:"OtherPID["+a+"] Received from other Peer candidate"}),e.receiveCandidate(b)},addRemoteStream:function(a,b,c){this.fire("addRemoteStream",a,b,c)},signalEnd:function(a){},onClose:function(a,b){p.trace("cdm",{klass:"Call",method:"onClose",channelId:this.getChannelId(),message:"Disconnected channel"}),this.fire("_disconnectChannel",a,b)},onOtherClose:function(a){var b=this.peers[a],c=null;if(!b)return void this.fire("_otherDisconnectChannel",a);c=b.uid,p.trace("cdm",{klass:"Call",method:"onOtherClose",channelId:this.getChannelId(),message:"OtherPID["+a+"] OtherUID["+c+"] Disconnected with other peer"}),b.peer&&b.peer.close(),delete this.peers[a];var d=0;for(var e in this.peers)d++;1>d&&this._startTurnInterval(),this.fire("_otherDisconnectChannel",a,c)},error:function(a,b,c){window.clearInterval(this.healthInterval),window.clearInterval(this.turnInterval),this.healthInterval=null,this.turnInterval=null,this.fire("error",a,b,c)},_stateChange:function(a,b,c){this.fire("stateChange",a,b,c)},destroy:function(){p.warn("cdm",{klass:"Call",method:"destroy",channelId:this.getChannelId(),message:"Destroyed instance of 'Call'"}),this.turnInterval&&(window.clearInterval(this.turnInterval),this.turnInterval=null);var a=null,b=this.peers;this.channeling&&this.channeling.socket.close();for(a in b)b[a].peer&&b[a].peer.close();this.peers={},this.healthInterval&&(window.clearInterval(this.healthInterval),this.healthInterval=null)},onUserCommand:function(a,b){this.fire("userCommand",a,b)}});o.Channeling=j.Extend(j.Event,{initialize:function(a,b){o.Channeling.base.initialize.call(this),this.url=b,this.call=a,p.trace("cdm",{klass:"Channeling",method:"initialize",channelId:this.call.getChannelId(),message:"Created instance of 'Channeling'"}),this.createSocket()},serialize:function(a){var b={header:{command:"",commandType:"req",token:this.call.getToken(),expireTime:"none",broadcast:"none",sender:{type:"peer",id:"none"},receiver:{type:"server",id:"none"}},body:{}};return JSON.stringify(j.apply(b,a))},signalSerialize:function(a){var b={header:{command:"",commandType:"req",token:this.call.getToken(),sender:{type:"peer",id:"none"},receiver:{type:"peer",id:"none"}},body:{}};return JSON.stringify(j.apply(b,a))},createSocket:function(){p.trace("cdm",{klass:"Channeling",method:"createSocket",channelId:this.call.getChannelId(),message:"WebSocket["+this.url+"] Created instance of 'Channeling Web Socket'"});try{this.socket=new n(this.url)}catch(a){return p.error("cdm",{klass:"Channeling",method:"createSocket",channelId:this.call.getChannelId(),message:"Failed to create instance of 'Channeling Web Socket'"}),void this.fire("error","C4002",l.C4002)}this.socket.on("open",j.bind(function(a){this.fire("onOpen")},this)).on("close",j.bind(function(a){p.trace("cdm",{klass:"Channeling",method:"createSocket",channelId:this.call.getChannelId(),message:"Closed 'Channeling Web Socket'"})},this)).on("error",j.bind(function(a){p.error("cdm",{klass:"Channeling",method:"createSocket",channelId:this.call.getChannelId(),message:"Caused error 'Channeling Web Socket'"}),this.fire("error","C4007",l.C4007)},this)).on("message",this.message,this)},send:function(a){1===this.socket.getReadyState()?this.socket.send(a):(p.error("cdm",{klass:"Channeling",method:"send",channelId:this.call.getChannelId(),message:"Already disconnected channel server"}),this.fire("error","C4003",l.C4003))},connect:function(a){var b=this.serialize({header:{command:"connect",sender:{env:{platformType:j.platform,browser:{name:j.browser.name,version:j.browser.version},sdk:{type:"web",version:o.version},networkType:"wired"}}},body:{data:{uid:this.call.getUid()||"none",channelId:a}}});p.trace("cdm",{klass:"Channeling",method:"connect",channelId:this.call.getChannelId(),message:"Sent to connect channel. data = "+b}),this.send(b)},userCommand:function(a,b){var a=this.serialize({header:{command:"userdefined",broadcast:b.length<1?"yes":"no",sender:{id:this.call.getPid()},receiver:{targets:b}},body:{data:{channelId:this.call.getChannelId(),userData:a}}});p.trace("cdm",{klass:"Channeling",method:"userCommand",channelId:this.call.getChannelId(),message:"Sent userdefined. data = "+a}),this.send(a)},accept:function(a){var b=this.serialize({header:{command:"on_ready",commandType:"res",sender:{type:"peer",id:this.call.getPid()}},body:{header:{code:"20001",desc:"SUCCESS"},data:{status:"yes",channelId:this.call.getChannelId(),targetId:a}}});p.trace("cdm",{klass:"Channeling",method:"accept",channelId:this.call.getChannelId(),message:"Sent to accept. data = "+b}),this.send(b)},reject:function(a){var b=this.serialize({header:{command:"on_ready",commandType:"res",sender:{type:"peer",id:this.call.getPid()}},body:{header:{code:"20001",desc:"SUCCESS"},data:{status:"no",channelId:this.call.getChannelId(),targetId:a}}});p.trace("cdm",{klass:"Channeling",method:"reject",channelId:this.call.getChannelId(),message:"Sent to reject. data = "+b}),this.send(b)},ring:function(a){var b=this.serialize({header:{command:"ready",sender:{id:this.call.getPid()}},body:{data:{channelId:this.call.getChannelId(),targetId:a}}});p.trace("cdm",{klass:"Channeling",method:"ring",channelId:this.call.getChannelId(),message:"Sent to ring. data = "+b}),this.send(b)},disconnectChannel:function(a){var b=this.serialize({header:{command:"peer_close",sender:{id:a}},body:{data:{channelId:this.call.getChannelId()}}});p.trace("cdm",{klass:"Channeling",method:"disconnectChannel",channelId:this.call.getChannelId(),message:"Sent to disconnectChannel. data = "+b}),this.send(b)},deleteChannel:function(){var a=this.serialize({header:{command:"channel_close",token:this.call.getToken(),sender:{id:this.call.getPid()}},body:{data:{channelId:this.call.getChannelId()}}});p.trace("cdm",{klass:"Channeling",method:"deleteChannel",channelId:this.call.getChannelId(),message:"Sent to delete. data = "+a}),this.send(a)},sendOfferSdp:function(a,b){var c=this.signalSerialize({header:{command:"sdp",sender:{id:this.call.getPid()},receiver:{type:"peer",id:a}},body:{data:{type:"offer",sdp:JSON.stringify(b)}}});p.trace("cdm",{klass:"Channeling",method:"sendOfferSdp",channelId:this.call.getChannelId(),message:"Sent offer sdp. data = "+c}),this.send(c)},sendAnswerSdp:function(a,b){var c=this.signalSerialize({header:{command:"sdp",sender:{id:this.call.getPid()},receiver:{id:a}},body:{data:{type:"answer",sdp:JSON.stringify(b)}}});p.trace("cdm",{klass:"Channeling",method:"sendAnswerSdp",channelId:this.call.getChannelId(),message:"Sent answer sdp. data = "+c}),this.send(c)},sendCandidate:function(a,b){var c=this.signalSerialize({header:{command:"candidate",sender:{id:this.call.getPid()},receiver:{id:a}},body:{data:{candidate:JSON.stringify(b)}}});p.trace("cdm",{klass:"Channeling",method:"sendCandidate",channelId:this.call.getChannelId(),message:"Sent candidate. data = "+c}),this.send(c)},health:function(){var a=this.serialize({header:{command:"health",sender:{},receiver:{}},body:{}});try{this.socket.send(a)}catch(b){p.error("cdm",{klass:"Channeling",method:"health",channelId:this.call.getChannelId(),message:"Failed to send health."})}},message:function(a){var c=JSON.parse(a.data),d=c.header,e=c.body,f=d.command.toUpperCase(),g=[],h=0,i=0;if("res"===d.commandType&&"SUCCESS"!==m[e.header.code])return p.error("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received message. data = "+a.data}),void b.call(this,"CHANNEL",e.header.code,c);switch(f){case"CONNECT":for(p.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received channel 'connect'. data = "+a.data}),h=e.data.others.length;h>i;i++)g.push({id:e.data.others[i].id,uid:"none"!==e.data.others[i].uid?e.data.others[i].uid:""});this.fire("onConnect",d.receiver.id,g);break;case"ON_CONNECT":p.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received channel 'on_connect'. data = "+a.data}),e.data.others.length>0&&this.fire("onOtherConnect",e.data.others[0].id,"none"!==e.data.others[0].uid?e.data.others[0].uid:"");break;case"READY":p.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'ring'. data = "+a.data}),e.data.status&&("yes"===e.data.status?this.fire("onAccept",e.data.targetId,"none"!==e.data.uid?e.data.uid:""):this.fire("onReject",e.data.targetId,"none"!==e.data.uid?e.data.uid:""));break;case"ON_READY":p.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Rreceived 'on_ring'. data = "+a.data}),this.fire("onRing",e.data.targetId,"none"!==e.data.uid?e.data.uid:"");break;case"CLOSE":p.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'close'. data = "+a.data}),this.fire("onClose",e.data.channelId,d.receiver.id);break;case"ON_CLOSE":p.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'on_close'. data = "+a.data}),this.fire("onOtherClose",e.data.targetId);break;case"ON_USERDEFINED":p.trace("cdm",{klass:"Channeling",method:"message",channelId:this.call.getChannelId(),message:"Received 'on_userdefined'. data = "+a.data}),this.fire("userCommand",e.data.targetId,e.data.userData);break;case"SDP":if("res"===d.commandType)return;type=e.data.type.toUpperCase(),"OFFER"===type?this.fire("receiveOfferSdp",d.sender.id,JSON.parse(e.data.sdp)):"ANSWER"===type&&this.fire("receiveAnwserSdp",d.sender.id,JSON.parse(e.data.sdp));break;case"CANDIDATE":if("res"===d.commandType)return;this.fire("receiveCandidate",d.sender.id,JSON.parse(e.data.candidate))}}});var r=j.Extend(j.Event,{initialize:function(a,b,c,d,e){r.base.initialize.call(this),this.config=j.apply({iceServers:null,dataChannelEnabled:!1,bandwidth:{video:1500,data:1638400}},e),this.call=a,this.id=b,this.uid=c,this.localStream=d,this.media=null,this.connected=!1,this.oldStats=null,this.statsReportTimer=null,this.preferCodec={audio:"ISAC",video:"H264"},this.fractionLost=this.call.playRtc.fractionLost||{audio:[{rating:1,fromAflost:0,toAflost:50},{rating:2,fromAflost:51,toAflost:150},{rating:3,fromAflost:151,toAflost:250},{rating:4,fromAflost:251,toAflost:350},{rating:5,fromAflost:351,toAflost:9999999}],video:[{rating:1,fromAflost:0,toAflost:40},{rating:2,fromAflost:41,toAflost:55},{rating:3,fromAflost:56,toAflost:70},{rating:4,fromAflost:71,toAflost:90},{rating:5,fromAflost:91,toAflost:9999999}]},p.trace("cdm",{klass:"Peer",method:"initialize",channelId:this.call.getChannelId(),message:"PID["+this.id+"]. Created instance of 'Peer'."})},setEvent:function(){var a=this.pc;a.onicecandidate=j.bind(function(a){p.trace("cdm",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),message:"Created candidate. candidate = "+JSON.stringify(a.candidate)}),a.candidate&&this.fire("sendCandidate",this.id,a.candidate)},this),a.onaddstream=j.bind(function(a){this.media=new s(a.stream),this.fire("addRemoteStream",this.id,this.uid,a.stream)},this),a.onsignalingstatechange=j.bind(function(a){this.fire("signalingstatechange",a)},this),a.oniceconnectionstatechange=j.bind(function(a){this.fire("iceconnectionstatechange",a);var b=a.target.iceConnectionState.toUpperCase(),c=a.target.iceGatheringState.toUpperCase();p.trace("cdm",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),message:"ConnectionState["+b+"] GatheringState["+c+"] Changed P2P state"}),("COMPLETED"===b||"CONNECTED"===b||"FAILED"===b)&&this.fire("signalEnd",this.id),"FAILED"===b?(p.error("cdmn",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),tokenId:this.call.getToken(),type:"p2p",callType:"offer"===this.call.peers[this.id].type?"callee":"caller",resultCode:"400",connectTime:(new Date).getTime(),networkType:"wired",candidate:"",audioYn:this.call.playRtc.userMedia.audio?"Y":"N",videoYn:this.call.playRtc.userMedia.video?"Y":"N",message:"PID["+this.call.getPid()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Failed P2P connection"}),this._error("P4001",l.P4001)):"CHECKING"===b?this.fire("stateChange","CHECKING",this.id,this.uid):"COMPLETED"===b||"CONNECTED"===b?(p.trace("cdm",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),message:"PID["+this.call.getPid()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Connected P2P"}),this.connected?p.trace("cdmn",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),tokenId:this.call.getToken(),type:"p2p",resultCode:"202",connectTime:(new Date).getTime(),message:"PID["+this.call.getPid()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Reconnected P2P"}):(this.getStats(j.bind(function(a){this.oldStats=a;var b;if("firefox"===j.browser.name){for(attr in a)if("candidatepair"===a[attr].type&&a[attr].selected===!0){b=a[a[attr].localCandidateId].candidateType;break}}else for(var c=0;c<a.length;c++)if("true"===a[c].googActiveConnection){b=a[c].googLocalCandidateType;break}p.trace("cdmn",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),tokenId:this.call.getToken(),type:"p2p",callType:"offer"===this.call.peers[this.id].type?"callee":"caller",resultCode:"200",connectTime:(new Date).getTime(),networkType:"wired",candidate:b,audioYn:this.call.playRtc.userMedia.audio?"Y":"N",videoYn:this.call.playRtc.userMedia.video?"Y":"N",message:"PID["+this.call.getPid()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Connected P2P"})},this)),this.fire("stateChange","SUCCESS",this.id,this.uid)),this.fire("stateChange","CONNECTED",this.id,this.uid),this.connected=!0):"DISCONNECTED"===b?(p.trace("cdmn",{klass:"Peer",method:"setEvent",channelId:this.call.getChannelId(),tokenId:this.call.getToken(),type:"p2p",resultCode:"401",message:"PID["+this.call.getPid()+"] UID["+this.call.getUid()+"] OtherPID["+this.id+"] OtherUID["+this.uid+"] Disconnected P2P"}),this.fire("stateChange","DISCONNECTED",this.id,this.uid)):"CLOSED"===b&&this.fire("stateChange","CLOSED",this.id,this.uid)},this),a.onremovestream=j.bind(function(a){this.fire("removestream",a)},this),a.onclose=j.bind(function(a){this.fire("close",a)},this)},createPeerConnection:function(){p.trace("cdm",{klass:"Peer",method:"createPeerConnection",channelId:this.call.getChannelId(),message:"PID["+this.id+"] Created instance of 'Native PeerConnection. Used iceServers = '"+JSON.stringify(this.config.iceServers)}),this.pc=new d({iceServers:this.config.iceServers},{optional:[{DtlsSrtpKeyAgreement:!0},{RtpDataChannels:!1}]}),this.setEvent(),this.localStream&&this.pc.addStream(this.localStream),j.dataChannelSupport&&this.config.dataChannelEnabled?(this.data=new t(this),this.data.on("open",j.bind(function(){this.call.playRtc.fire("addDataStream",this.id,this.uid,this.data)},this))):this.config.dataChannelEnabled&&p.warn("cdm",{klass:"Peer",method:"createPeerConnection",channelId:this.call.getChannelId(),message:"PID["+this.id+"] Didn't create data channel"})},replaceBandWidth:function(a,b){if("firefox"===j.browser.name)return a;if(!this.config.bandwidth)return a;var c=this.config.bandwidth.video,d=this.config.bandwidth.data,e=new RegExp("a=rtpmap:(\\d+) "+b+"/(\\d+)");return a=a.replace(/b=AS([^\r\n]+\r\n)/g,""),a=a.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+(c>0?c:2500)+"\r\n"),a=a.replace(e,"a=rtpmap:$1 "+b+"/$2\r\na=fmtp:$1 x-google-start-bitrate=1000; x-google-min-bitrate=600; x-google-max-bitrate="+(c>0?c:2500)+"; x-google-max-quantization=56"),a=a.replace(/a=mid:data\r\n/g,"a=mid:data\r\nb=AS:"+(d>0?d:1638400)+"\r\n")},replacePreferCodec:function(a,b,c){var d,e,f,g=[],h=new RegExp("a=rtpmap:(\\d+) "+c+"/\\d+");if(d=a.match(b),!d)return a;if(e=a.match(h),!e)return a;d=d[0],e=e[1],f=d.split(" "),g.push(f[0]),g.push(f[1]),g.push(f[2]),g.push(e);for(var i=3;i<f.length;i++)f[i]!==e&&g.push(f[i]);return a.replace(d,g.join(" "))},_getConstraints:function(){var a;return a="firefox"===j.browser.name?{offerToReceiveAudio:!0,offerToReceiveVideo:!0}:{optional:[{VoiceActivityDetection:!1},{DtlsSrtpKeyAgreement:!0}],mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}},createOffer:function(){this.createPeerConnection(),this.pc.createOffer(j.bind(function(a){a.sdp=this.replaceBandWidth(a.sdp,this.preferCodec.video),a.sdp=this.replacePreferCodec(a.sdp,/m=audio(:?.*)?/,this.preferCodec.audio),a.sdp=this.replacePreferCodec(a.sdp,/m=video(:?.*)?/,this.preferCodec.video),p.trace("cdm",{klass:"Peer",method:"createOffer",channelId:this.call.getChannelId(),message:"Create offer sdp. offerSdp = "+JSON.stringify(a)}),this.pc.setLocalDescription(a),this.fire("sendOfferSdp",this.id,a)},this),j.bind(function(){p.error("cdm",{klass:"Peer",method:"createOffer",channelId:this.call.getChannelId(),message:"Failed to create offer sdp"}),this._error("C4008",l.C4008)},this),this._getConstraints())},createAnswer:function(a){this.pc||this.createPeerConnection();var b=this.pc;try{b.setRemoteDescription(new e(a)),p.trace("cdm",{klass:"Peer",method:"createAnswer",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Set offer sdp. offerSdp = "+JSON.stringify(a)})}catch(c){return p.error("cdm",{klass:"Peer",method:"createAnswer",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Failed to set offer sdp"}),void this._error("C4009",l.C4009)}b.createAnswer(j.bind(function(a){a.sdp=this.replaceBandWidth(a.sdp,this.preferCodec.video),a.sdp=this.replacePreferCodec(a.sdp,/m=audio(:?.*)?/,this.preferCodec.audio),a.sdp=this.replacePreferCodec(a.sdp,/m=video(:?.*)?/,this.preferCodec.video),p.trace("cdm",{klass:"Peer",method:"createAnswer",channelId:this.call.getChannelId(),message:"Created answer sdp. answerSdp = "+JSON.stringify(a)}),this.pc.setLocalDescription(a),this.fire("sendAnswerSdp",this.id,a)},this),j.bind(function(a){p.error("cdm",{klass:"Peer",method:"createAnswer",channelId:this.call.getChannelId(),message:"Failed to create answer sdp"}),this._error("C4008",l.C4008)},this),this._getConstraints())},receiveAnwserSdp:function(a){var b=this.pc;try{b.setRemoteDescription(new e(a)),p.trace("cdm",{klass:"Peer",method:"receiveAnwserSdp",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Set anwser sdp. anwserSdp = "+JSON.stringify(a)})}catch(c){p.error("cdm",{klass:"Peer",method:"receiveAnwserSdp",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Failed to set anwser sdp"}),this._error("C4009",l.C4009)}},receiveCandidate:function(a){this.pc||this.createPeerConnection();var b=this.pc;try{a=new f(a),b.addIceCandidate(a),p.trace("cdm",{klass:"Peer",method:"receiveCandidate",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Set candidate. candidate = "+JSON.stringify(a)})}catch(c){p.error("cdm",{klass:"Peer",method:"receiveCandidate",channelId:this.call.getChannelId(),message:"OtherPID["+this.id+"] Failed to set candidate"}),this._error("C4010",l.C4010)}},close:function(){this.pc&&this.pc.close(),this.pc=null,this.stopStatsReport()},getDataChannel:function(){return this.data},getMedia:function(){return this.media?this.media:null},getPeerConnection:function(){return this.pc},getStats:function(a){return this.call.playRtc.userMedia.video||this.call.playRtc.userMedia.audio?void("firefox"===j.browser.name?this.pc.getStats(null,j.bind(function(b){a.call(this,b)},this),function(){}):this.pc.getStats(j.bind(function(b){var c=[];b.result().forEach(function(a){var b={};a.names().forEach(function(c){b[c]=a.stat(c)}),b.id=a.id,b.type=a.type,b.timestamp=a.timestamp,c.push(b)}),a.call(this,c)},this))):void a.call(this,!1)},startStatsReport:function(a,b){this.statsReportTimer&&(window.clearInterval(this.statsReportTimer),this.statsReportTimer=null),2e3>a&&(a=2e3),this.statsReportTimer=window.setInterval(j.bind(function(){this.getStats(j.bind(function(a){var c,d,e=0,f=0,g=null,h={localCandidate:"",remoteCandidate:"",localFrameWidth:"",localFrameHeight:"",remoteFrameWidth:"",remoteFrameHeight:"",localFrameRate:"",remoteFrameRate:"",availableSendBandwidth:0,availableReceiveBandwidth:0,rtt:0,rttRating:"",localAudioFractionLost:0,localVideoFractionLost:0,localAudioFractionRating:0,localVideoFractionRating:0,remoteAudioFractionLost:0,remoteVideoFractionLost:0,remoteAudioFractionRating:0,remoteVideoFractionRating:0,fractionRating:0},i=0,k=0,l=0,m=0,n=0,o=0,p=0,q=0,r=0,s=0,t=0,u=0,v=0,w=0,x=0,y=0,z=this.oldStats;if("firefox"===j.browser.name){for(g in a)"candidatepair"!==a[g].type||a[g].selected!==!0?"inboundrtp"!==a[g].type||"audio"!==a[g].mediaType||a[g].isRemote!==!0?"inboundrtp"!==a[g].type||"video"!==a[g].mediaType||a[g].isRemote!==!0||(a[g].hasOwnProperty("mozRtt")&&(d=a[g].mozRtt),a[g].hasOwnProperty("packetsLost")&&(s=a[g].packetsLost),a[g].hasOwnProperty("packetsReceived")&&(u=a[g].packetsReceived)):(a[g].hasOwnProperty("mozRtt")&&(c=a[g].mozRtt),a[g].hasOwnProperty("packetsLost")&&(r=a[g].packetsLost),a[g].hasOwnProperty("packetsReceived")&&(t=a[g].packetsReceived)):(h.localCandidate=a[a[g].localCandidateId].candidateType,h.remoteCandidate=a[a[g].remoteCandidateId].candidateType);for(g in z)"inboundrtp"!==a[g].type||"audio"!==a[g].mediaType||a[g].isRemote!==!0?"inboundrtp"!==a[g].type||"video"!==a[g].mediaType||a[g].isRemote!==!0||(a[g].hasOwnProperty("packetsLost")&&(w=a[g].packetsLost),a[g].hasOwnProperty("packetsReceived")&&(y=a[g].packetsReceived)):(a[g].hasOwnProperty("packetsLost")&&(v=a[g].packetsLost),a[g].hasOwnProperty("packetsReceived")&&(x=a[g].packetsReceived));this.call.playRtc.userMedia.video?h.rtt=d:h.rtt=c}else{for(f=a.length;f>e;e++)"true"!==a[e].googActiveConnection?a[e].hasOwnProperty("audioInputLevel")?(i=parseInt(a[e].packetsLost),l=parseInt(a[e].packetsSent)):a[e].hasOwnProperty("googFrameWidthSent")?(h.localFrameWidth=parseInt(a[e].googFrameWidthSent),h.localFrameHeight=parseInt(a[e].googFrameHeightSent),h.localFrameRate=parseInt(a[e].googFrameRateSent),k=parseInt(a[e].packetsLost),m=parseInt(a[e].packetsSent)):a[e].hasOwnProperty("audioOutputLevel")?(r=parseInt(a[e].packetsLost),t=parseInt(a[e].packetsReceived)):a[e].hasOwnProperty("googFrameWidthReceived")?(h.remoteFrameWidth=parseInt(a[e].googFrameWidthReceived),h.remoteFrameHeight=parseInt(a[e].googFrameHeightReceived),h.remoteFrameRate=parseInt(a[e].googFrameRateReceived),s=parseInt(a[e].packetsLost),u=parseInt(a[e].packetsReceived)):a[e].hasOwnProperty("googAvailableSendBandwidth")&&(h.availableSendBandwidth=parseInt(a[e].googAvailableSendBandwidth),h.availableReceiveBandwidth=parseInt(a[e].googAvailableReceiveBandwidth)):(h.localCandidate=a[e].googLocalCandidateType,h.remoteCandidate=a[e].googRemoteCandidateType,h.rtt=parseInt(a[e].googRtt));for(e=0;e<z.length;e++)z[e].hasOwnProperty("audioInputLevel")?(n=parseInt(z[e].packetsLost),p=parseInt(z[e].packetsSent)):z[e].hasOwnProperty("googFrameWidthSent")?(o=parseInt(z[e].packetsLost),q=parseInt(z[e].packetsSent)):z[e].hasOwnProperty("audioOutputLevel")?(v=parseInt(z[e].packetsLost),x=parseInt(z[e].packetsReceived)):z[e].hasOwnProperty("googFrameWidthReceived")&&(w=parseInt(z[e].packetsLost),y=parseInt(z[e].packetsReceived))}var A=parseFloat(parseFloat((i-n)/(l-p)*255||0).toFixed(4)),B=parseFloat(parseFloat((k-o)/(m-q)*255||0).toFixed(4));h.localAudioFractionLost=A,h.localVideoFractionLost=B,h.localAudioFractionRating=this._getAFLostRating(A),h.localVideoFractionRating=this._getVFLostRating(B);var C=parseFloat(parseFloat((r-v)/(t-x)*255||0).toFixed(4)),D=parseFloat(parseFloat((s-w)/(u-y)*255||0).toFixed(4));h.remoteAudioFractionLost=C,h.remoteVideoFractionLost=D,h.remoteAudioFractionRating=this._getAFLostRating(C),h.remoteVideoFractionRating=this._getVFLostRating(D),h.fractionRating=h.remoteVideoFractionRating,h.rttRating=this._getRttRating(h.rtt),this.oldStats=a,b&&b.call(this,h)},this))},this),a)},stopStatsReport:function(){this.statsReportTimer&&(window.clearInterval(this.statsReportTimer),this.statsReportTimer=null)},_getRttRating:function(a){var b=0;return a/2>=500?b=5:a/2>=400?b=4:a/2>=300?b=3:a/2>=200?b=2:200>a/2&&(b=1),b},_getAFLostRating:function(a){for(var b=this.fractionLost.audio,c=0;c<b.length;c++)if(b[c].fromFractionLost<=a&&b[c].toFractionLost>=a)return b[c].rating},_getVFLostRating:function(a){for(var b=this.fractionLost.video,c=0;c<b.length;c++)if(b[c].fromFractionLost<=a&&b[c].toFractionLost>=a)return b[c].rating},_error:function(a,b){this.fire("error",a,b,{pid:this.id,uid:this.uid})}}),s=function(){var a=function(a,b){this.type=b,this.stream=a,this.recordingCb=null,this.stopCb=null,this.mr=new MediaRecorder(this.stream),this.array=[],this.mr.ondataavailable=j.bind(function(a){this.array.push(a.data),this.recordingCb&&this.recordingCb(a.data)},this),this.mr.onstop=j.bind(function(a){var b=new Blob(this.array,{type:this.type});this.stopCb&&this.stopCb(b),this.stopCb=null},this)};return a.prototype.start=function(a){this.recordingCb=a,this.mr.start(3e3)},a.prototype.stop=function(a){this.stopCb=a,this.mr.stop()},j.Extend(j.Event,{initialize:function(a){s.base.initialize.call(this),this.stream=a,this.recorder=null},createRecorder:function(){j.mediaRecorderSupport||p.warn("cdm",{klass:"Media",method:"createRecorder",message:"Media Recorder is not suporrted"});var b=null,c=this.getStream();return videoTrack=this.getVideoTrack(),b=videoTrack?new a(c,"video/webm"):new a(c,"audio/ogg; codecs=opus")},record:function(a){return this.recorder?void p.error("cdm",{klass:"Media",method:"record",message:"Must call recordStop first"}):(p.trace("cdm",{klass:"Media",method:"record",message:"MediaStream Started record"}),this.recorder=this.createRecorder(),void(this.recorder&&this.recorder.start(a)))},recordStop:function(a){return this.recorder?(p.trace("cdm",{klass:"Media",method:"recordStop",message:"Stopped record"}),this.recorder.stop(a),void(this.recorder=null)):void p.error("cdm",{klass:"Media",method:"recordStop",message:"Failed to execute 'recordStop' on this.recorder is null"})},getStream:function(){return this.stream},getVideoTrack:function(){var a=this.getStream(),b=a.getVideoTracks();return b.length>0?b[0]:null},getAudioTrack:function(){var a=this.getStream(),b=a.getAudioTracks();return b.length>0?b[0]:null},audioMute:function(a){var b=this.getAudioTrack();return b?(b.enabled=a,!0):!1},videoMute:function(a){var b=this.getVideoTrack();return b?(b.enabled=a,!0):!1},mute:function(a){this.audioMute(a),this.videoMute(a)},stop:function(){var a=this.getVideoTrack(),b=this.getAudioTrack();a&&a.stop(),b&&b.stop(),this.stream.stop&&this.stream.stop()}})}(),t=function(){function a(){return(new Date).getTime()}function b(a,b){var c=new Uint8Array(a.byteLength+b.byteLength);return c.set(new Uint8Array(a),0),c.set(new Uint8Array(b),a.byteLength),c.buffer}if(!j.blobWorkerSupport)return!1;var c={0:"text",1:"binary"},d={0:"master",1:"frag"},e={},f={};return j.Extend(j.Event,{initialize:function(a){t.base.initialize.call(this),this.peer=a,this.sending=!1,this.queue=[],this.dataChannel=this.peer.getPeerConnection().createDataChannel("channel",{id:1}),this.fileReceiveStartTime=0,this.dataChannel.binaryType="arraybuffer",this.setEvent(),p.trace("cdm",{klass:"Data",method:"initialize",message:"PID["+this.peer.id+"]. Created instance of 'Data'"})},setEvent:function(){function a(a){var b=new DataView(a),d=b.getFloat64(0),g=b.getInt32(20);try{e[d]?this.textReceive(d,b,a):f[d]?this.fileReceive(d,b,a):"text"===c[g]?this.textReceive(d,b,a):this.fileReceive(d,b,a)}catch(h){p.error("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Failed to receive message"}),this.fire("error",h)}}var b=this.dataChannel;b.onopen=j.bind(function(a){p.trace("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Opened dataChannel"}),this.fire("open",a)},this),b.onclose=j.bind(function(a){p.trace("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Closed dataChannel"}),this.fire("close",a)},this),b.onerror=j.bind(function(a){p.error("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Caused error"}),this.fire("error",a)},this),b.onmessage=j.bind(function(b){
p.trace("cdm",{klass:"Data",method:"setEvent",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Received message"}),a.call(this,b.data)},this)},send:function(a,b,c){a.size&&a.name?(this.sending?this.queue.push({message:a,success:b,error:c}):this.sendFile(a,b,c),this.sending=!0):(a=a.toString(),this.sendText(a,b,c))},bufferedSend:function(a){var b=this.dataChannel;try{b.send(a),p.trace("cdm",{klass:"Data",method:"bufferedSend",channelId:this.peer.call.getChannelId(),message:"Sent message"})}catch(c){return p.error("cdm",{klass:"Data",method:"bufferedSend",channelId:this.peer.call.getChannelId(),message:"Failed to send dataChannel message error"}),!1}return!0},sendText:function(c,d,e){var f,g,h,i,k=(this.dataChannel,a()),l=new ArrayBuffer(20),m=new DataView(l),n=new ArrayBuffer(2*c.length),o=new Uint8Array(n),p=0,q=null,r=c.length,s=0,t=n.byteLength;m.setFloat64(0,k),m.setInt32(8,1);for(var u=j.bind(function(a,f,g){var h=f[g];return this.fire("sending",{id:k,type:"text",totalSize:t,fragSize:f[g].byteLength,fragCount:i,fragIndex:g}),this.bufferedSend(b(a,h))?void(g+1<f.length?window.setTimeout(function(){var a=g+1;m.setInt32(12,a),m.setInt32(16,f[a].byteLength),u(m.buffer,f,a)},100):d&&d(c)):void(e&&e(c))},this);r>p;p++)q=c.charCodeAt(p),o[s]=q>>>8,o[s+1]=255&q,s+=2;var f=this.packetSplit(n,8192),g=new ArrayBuffer(36),h=new DataView(g);i=f.length,h.setFloat64(0,k),h.setInt32(8,0),h.setFloat64(12,t),h.setInt32(20,0),h.setInt32(24,i),h.setInt32(28,0),h.setInt32(32,f[0].byteLength),u(h.buffer,f,0)},sendFile:function(c,d,e){function f(a){var e=new FileReader,q=0,s=null;q=a+l,e.onload=j.bind(function(e){if(0===a?s=r.buffer:(n++,w.setInt32(12,n),w.setInt32(16,e.target.result.byteLength),s=w.buffer),m.fire("sending",{id:h,type:"binary",fileName:i,mimeType:k,totalSize:o,fragSize:e.target.result.byteLength,fragCount:p,fragIndex:n}),m.bufferedSend(b(s,e.target.result)),o>a+e.target.result.byteLength)if(0!==g.bufferedAmount)var j=window.setInterval(function(){0===g.bufferedAmount&&(window.clearInterval(j),j=null,f(q))},0);else f(q);else m.sending=!1,d&&d(c),nextData=m.queue.pop(),nextData&&m.send(nextData.message,nextData.success,nextData.error)},this);var t=c.slice(a,q);e.readAsArrayBuffer(t)}var g=this.dataChannel,h=a(),i=c.name,k=c.type,l=8192,m=this,n=0,o=c.size,p=Math.ceil(o/l),q=new ArrayBuffer(548),r=new DataView(q),s=null;r.setFloat64(0,h),r.setInt32(8,0),r.setFloat64(12,o),r.setInt32(20,1);for(var t=24,u=0;280>t;t+=2)s=i.charCodeAt(u),s&&(r.setUint8(t,s>>>8),r.setUint8(t+1,255&s)),u++;for(var t=280,u=0;536>t;t+=2)s=k.charCodeAt(u),s&&(r.setUint8(t,s>>>8),r.setUint8(t+1,255&s)),u++;r.setInt32(536,p),r.setInt32(540,n),l>o?r.setInt32(544,o):r.setInt32(544,l);var v=new ArrayBuffer(20),w=new DataView(v);w.setFloat64(0,h),w.setInt32(8,1),f(0)},textReceive:function(a,c,f){var g={},h=null,i=c.getInt32(8);if(g.peerId=this.peer.id,"master"===d[i]?(g.id=a,g.totalSize=c.getFloat64(12),g.fragCount=c.getInt32(24),g.fragIndex=c.getInt32(28),g.fragSize=c.getInt32(32),h=f.slice(36),e[a]=[],e[a].totalSize=g.totalSize,e[a].fragCount=g.fragCount,e[a].push(h)):(g.id=a,g.type="text",g.totalSize=e[a].totalSize,g.fragCount=e[a].fragCount,g.fragIndex=c.getInt32(12),g.fragSize=c.getInt32(16),h=f.slice(20),e[a].push(h)),this.fire("progress",g),g.fragCount-1===g.fragIndex)try{for(var j=e[a].length,k=e[a],l=new ArrayBuffer(0),m=null,n=[],o=0,q=0;j>o;o++)l=b(l,k[o]);for(o=0,m=new Uint8Array(l),q=l.byteLength;q>o;)n.push((255&m[o++])<<8|255&m[o++]);if(!this.hasEvent("message"))return alert("You must create message's event."),!1;this.fire("message",{type:"text",id:a,peerId:this.peer.id,totalSize:k.totalSize,data:String.fromCharCode.apply(null,n)})}catch(r){p.error("cdm",{klass:"Data",method:"textReceive",channelId:this.peer.call.getChannelId(),message:"PID["+this.peer.id+"] Caused error"}),this.fire("error",r)}},fileReceive:function(a,b,c){var e={},g=null,h=b.getInt32(8),j=null,k=null,j=null;if(e.peerId=this.peer.id,"master"===d[h]){for(e.totalSize=b.getFloat64(12),e.fileName="",i=24;i<280;i+=2)k=String.fromCharCode(b.getInt16(i)),0!==k.charCodeAt(0)&&(e.fileName=e.fileName+k);for(e.mimeType="",i=280;i<536;i+=2)k=String.fromCharCode(b.getInt16(i)),0!==k.charCodeAt(0)&&(e.mimeType=e.mimeType+k);e.id=a,e.fragCount=b.getInt32(536),e.fragIndex=b.getInt32(540),e.fragSize=b.getInt32(544),g=c.slice(548),f[a]=[],f[a].totalSize=e.totalSize,f[a].fileName=e.fileName,f[a].mimeType=e.mimeType,f[a].fragCount=e.fragCount,f[a].push(g),this.fileReceiveStartTime=(new Date).getTime()}else e.id=a,e.type="binary",e.fileName=f[a].fileName,e.mimeType=f[a].mimeType,e.totalSize=f[a].totalSize,e.fragCount=f[a].fragCount,e.fragIndex=b.getInt32(12),e.fragSize=b.getInt32(16),g=c.slice(20),f[a].push(g);if(this.fire("progress",e),e.fragCount-1===e.fragIndex){try{var j=new Blob(f[a],{type:f[a].mimeType});this.fire("message",{type:"binary",id:a,peerId:this.peer.id,fileName:f[a].fileName,mimeType:f[a].mimeType,totalSize:f[a].totalSize,blob:j}),p.trace("cdmn",{klass:"PlayRTC",method:"fileReceive",channelId:this.peer.call.getChannelId(),tokenId:this.peer.call.getToken(),type:"data",callType:"offer"===this.peer.call.peers[this.peer.id].type?"callee":"caller",resultCode:"200",fileRcvSize:f[a].totalSize,fileRcvTime:(new Date).getTime()-this.fileReceiveStartTime,message:"PID["+this.peer.id+"] Succeeded to receive a file. name = "+f[a].fileName}),this.fileReceiveStartTime=0}catch(l){this.fire("error",{type:"binary",id:a,peerId:this.peer.id,fileName:f[a].fileName,mimeType:f[a].mimeType,totalSize:f[a].totalSize}),p.error("cdmn",{klass:"PlayRTC",method:"fileReceive",channelId:this.peer.call.getChannelId(),tokenId:this.peer.call.getToken(),type:"data",callType:"offer"===this.peer.call.peers[this.peer.id].type?"callee":"caller",resultCode:"601",fileRcvSize:0,fileRcvTime:0,message:"PID["+this.peer.id+"] Failed to receive a file. name = "+f[a].fileName})}f[a]=null}},packetSplit:function(a,b){for(var c=[],d=b,e=a.byteLength,f=Math.ceil(e/d),g=0;f>g;g++)c.push(a.slice(g*d,(g+1)*d));return c},close:function(){this.dataChannel.close(),this.peer.data=null}})}(),u={url:"https://apis.sktelecom.com/v3/playrtc",projectKey:null,setUrl:function(a){this.url=a},setProjectKey:function(a){this.projectKey=a},getProjectKey:function(){return this.projectKey},createChannel:function(b,c,d){var e=this.url+"/channels/channel",f="post";b.nag={userExpires:"86000"},a({body:b,projectKey:this.getProjectKey(),method:f,url:e,success:c,error:d})},connectChannel:function(b,c,d,e){var f=this.url+"/channels/channel/"+b;method="put",c.nag={userExpires:"86000"},a({body:c,projectKey:this.getProjectKey(),method:method,url:f,success:d,error:e})},getChannelList:function(b,c){var d=this.url+"/channels",e="get";a({projectKey:this.getProjectKey(),method:e,url:d,success:b,error:c})},getChannel:function(b,c,d){var e=this.url+"/channels/channel/"+b,f="get";a({projectKey:this.getProjectKey(),method:f,url:e,success:c,error:d})},getPeerList:function(b,c,d){var e=this.url+"/channels/channel/"+b+"/peers",f="get";a({projectKey:this.getProjectKey(),method:f,url:e,success:c,error:d})},getPeer:function(b,c,d,e){var f=this.url+"/channels/channel/"+b+"/peers/peer/"+c,g="get";a({projectKey:this.getProjectKey(),method:g,url:f,success:d,error:e})},searchChannel:function(b,c,d,e){var f=this.url+"/channels/search?f="+b+"&q="+c,g="get";a({projectKey:this.getProjectKey(),method:g,url:f,success:d,error:e})},log:function(b,c){var d=this.url+"/stat",e="put";a({body:b,projectKey:this.getProjectKey(),method:e,url:d,error:c})}};return function(a){Object.defineProperties?Object.defineProperties(a,{version:{get:function(){return"2.2.14"}},activeXversion:{get:function(){return"1,0,0,60"}},utils:{get:function(){return j}}}):(a.version="2.2.14",a.activeXversion="1,0,0,60",a.utils=j)}(o),d&&e&&f?j.webRtcSupport=!0:(p.warn("cdm",{message:"Your browser is not supported about WebRTC."}),j.webRtcSupport=!1),j.dataChannelSupport=function(a){try{var b=new d(a,{optional:[{RtpDataChannels:!0}]}),c=!0,e=null;try{e=b.createDataChannel("_support"),e.close()}catch(f){c=!1,p.warn("cdm",{tag:"utils",message:"DataChannel is not supported."})}}catch(f){c=!1,p.warn("cdm",{tag:"utils",message:"DataChannel is not supported."})}return c}(),o});